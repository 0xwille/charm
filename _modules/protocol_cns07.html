

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>protocol_cns07 &mdash; Charm-Crypto 0.4b documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.4b',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Charm-Crypto 0.4b documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Charm-Crypto 0.4b documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for protocol_cns07</h1><pre>

| From: "J. Camenisch, G. Neven, a. shelat - Simulatable Adaptive Oblivious Transfer"
| Published in: EUROCRYPT 2007
| Available from: http://eprint.iacr.org/2008/014
| Notes: 

* type:           signature (ID-based)
* setting:        bilinear groups (asymmetric)

:Authors:    J. Ayo Akinyele
:Date:       2/2012
"""
from charm.engine.protocol import *
from charm.engine.util import *
from socket import *
from toolbox.pairinggroup import *
from schemes.sigma1 import *
from schemes.sigma2 import *
from schemes.sigma3 import *
import sys

SENDER,RECEIVER = 1,2
HOST, PORT = "", 8083

class ObliviousTransfer(Protocol):
    def __init__(self, messages=None, groupObj=None, common_input=None):        
<div class="viewcode-block" id="ObliviousTransfer"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer">[docs]</a>        Protocol.__init__(self, None)        
        receiver_states = { 2:self.receiver_init2, 4:self.receiver_transfer4, 6:self.receiver_transfer6, 8:self.receiver_transfer8 }
        sender_states = { 1:self.sender_init1, 3:self.sender_init3, 5:self.sender_transfer5, 7:self.sender_transfer7, 9:self.sender_transfer9 }

        receiver_trans = { 2:4, 4:6, 6:8 }
        sender_trans = { 1:3, 3:[3,5], 5:7, 7:9 }
        # describe the parties involved and the valid transitions
        Protocol.addPartyType(self, RECEIVER, receiver_states, receiver_trans)
        Protocol.addPartyType(self, SENDER, sender_states, sender_trans, True)
#        Protocol.setSerializers(self, self.serialize, self.deserialize)
        # make sure 
        if groupObj == None:
            self.group = PairingGroup('SS512')
        else:
            self.group = groupObj
        # proof parameter generation
        if common_input == None: # generate common parameters to P and V
            db = {}
            self.__gen_setup = True
        else: # can be used as a sub-protocol if common_input is specified by caller
            db = common_input
            self.__gen_setup = False
        Protocol.setSubclassVars(self, self.group, db) 
        if messages != None:
            self.M, self.sig = [], []
            for i in range(0, len(messages)):
                self.M.append( bytes(messages[i], 'utf8') )
                print("bytes =&gt;", self.M[i],", message =&gt;", messages[i])                
#                self.M.append(self.group.hash(messages[i], ZR))
#                self.sig.append(messages[i])
        # dict to hold variables from interaction        

    def get_common(self):
        if self.__gen_setup:
<div class="viewcode-block" id="ObliviousTransfer.get_common"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer.get_common">[docs]</a>            g, h = self.group.random(G1), self.group.random(G2)
            H = pair(g, h)
            Protocol.store(self, ('g', g), ('h', h), ('H', H) )
            return (g, h, H)
        else: # common parameters generated already
            return Protocol.get(self, ['g', 'h', 'H'])
    
    # msgs =&gt; dict of M -&gt; H(M)
    def sender_init1(self):
        M = self.M</div>
<div class="viewcode-block" id="ObliviousTransfer.sender_init1"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer.sender_init1">[docs]</a>        print("SENDER 1: ")
        (g, h, H) = self.get_common()  
        x = self.group.random(ZR)
        y = g ** x
        print("send g =&gt;", g)
        print("send h =&gt;", h)
        print("send H =&gt;", H)
        print("send x =&gt;", x)
        print("send y =&gt;", y)
        A, B, C = {}, {}, {}
        for i in range(0, len(self.M)):
            j = self.group.init(ZR, i+1)
            print("j =&gt;", j)
            A[i] = g ** ~(x + j)
            B[i] = pair(A[i], h)  #, M[i])
            C[i] = { 'A':A[i], 'B':B[i] }
        
        S = { 'g':g, 'h':h, 'H':H, 'y':y }        
        Protocol.store(self, ('x', y), ('y',y), ('C', C) )
        Protocol.setState(self, 3)
        return { 'S':S, 'C':C , 'PoK':'SigmaProtocol1' }
    
    def sender_init3(self, input):
        print("SENDER 3: ", input)</div>
<div class="viewcode-block" id="ObliviousTransfer.sender_init3"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer.sender_init3">[docs]</a>        result = 'FAIL'
        pk = Protocol.get(self, ['g', 'H', 'h'], dict)
        if input == 'GO':
            PoK1 = SigmaProtocol1(self.group, pk)
            PoK1.setup( {'name':'prover', 'type':PoK1.PROVER, 'socket':self._socket} )
            PoK1.execute(PoK1.PROVER, close_sock=False)
#            print("PoK1 prover result =&gt;", PoK1.result)

            if PoK1.result == 'OK':
           # transition to transfer phase
                Protocol.setState(self, 5)
                result = PoK1.result
#        else: # JAA - something to this effect (Error case doesn't work yet)
#           Protocol.setState(self, 3); return {'PoK': 'REDO' }
        # need store and get functions for db        
        return {'PoK': result }
    
    def sender_transfer5(self, input):
        print("SENDER 5: query =&gt;", input)</div>
<div class="viewcode-block" id="ObliviousTransfer.sender_transfer5"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer.sender_transfer5">[docs]</a>        
        if input.get('PoK') != None: # continue
            Protocol.setState(self, 7)
            return 'OK'    
        Protocol.setState(self, None)
        return None
    
    def sender_transfer7(self, input):
#        print("SENDER 7: input =&gt;", input)</div>
<div class="viewcode-block" id="ObliviousTransfer.sender_transfer7"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer.sender_transfer7">[docs]</a>        if input.get('PoK2') != None: 
#            pk = Protocol.get(self, ['g','g2','y'], dict)           
            V = Protocol.get(self, ['V'])
            pk = { 'V':V }
            PoK2 = SigmaProtocol2(self.group, pk)
            PoK2.setup( {'name':'verifier', 'type':PoK2.VERIFIER, 'socket':self._socket} )
            Protocol.send_msg(self, 'GO')
            PoK2.execute(PoK2.VERIFIER, close_sock=False)
#            print("PoK2 verifier result =&gt;", PoK2.result)
            result = PoK2.result

        if result == 'OK':
#           print("transitioning to transfer9 result =&gt;", result)
           h, V = Protocol.get(self, ['h','V'])             
           W = pair(V, h)
           Protocol.setState(self, 9)
           return { 'PoK2':result, 'W':W, 'PoM':'SigmaProtocol3' }
        Protocol.setState(self, None)
        return None
    
    def sender_transfer9(self, input):
#        print("SENDER 9: PoM init =&gt;", input)           </div>
<div class="viewcode-block" id="ObliviousTransfer.sender_transfer9"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer.sender_transfer9">[docs]</a>        
        if input == 'GO':    
#           print("Executing the PoM interactive proof.")
           pk = Protocol.get(self, ['h','g','H','V'], dict) 
           PoM = SigmaProtocol3(self.group, pk)
           PoM.setup( {'name':'prover', 'type':PoM.PROVER, 'socket':self._socket} )
           PoM.execute(PoM.PROVER)
           print("PoM prover result =&gt;", PoM.result)
            
        Protocol.setState(self, None)
        return None
#################################    
# END of SENDER state functions #
#################################    
    
    def receiver_init2(self, input):
        print("RECEIVER 2: ")</div>
<div class="viewcode-block" id="ObliviousTransfer.receiver_init2"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer.receiver_init2">[docs]</a>        pk = Sigma.get(self, ['S'])
        if input['PoK'] == 'SigmaProtocol1':
            PoK1 = SigmaProtocol1(self.group, pk)
            PoK1.setup( {'name':'verifier', 'type':PoK1.VERIFIER, 'socket': self._socket} )
            Protocol.send_msg(self, 'GO') # important: 1. acknowledges sub-protocol transition, 2. sends a short message using this socket
            PoK1.execute(PoK1.VERIFIER, close_sock=False)
            print("PoK1 verifier result =&gt;", PoK1.result)
            result = PoK1.result

        if result == 'OK':            
            Protocol.setState(self, 4) # desired: 4 (TBD)
        return {'PoK': result } # result should be R0 (state info) for Receiver
        # let sender know to expect a PoK2 interaction next

    def receiver_transfer4(self, input): # rec_tran4 -&gt; sender_tran5
        print("RECEIVER 4: Get query from end user.")</div>
<div class="viewcode-block" id="ObliviousTransfer.receiver_transfer4"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer.receiver_transfer4">[docs]</a>        index = 0 # maps to position 0 in array (+1 indexed)
        C = Protocol.get(self, ['C'])[0]
        v = self.group.random(ZR) # secret for Receiver
        V = C[index]['A'] ** v # public value
        Protocol.setState(self, 6)
        Protocol.store( self, ('v',v), ('V',V), ('query', index+1) )
        return { 'V':V, 'PoK2':'SigmaProtocol2' }
    
    def receiver_transfer6(self, input):
        print("RECEIVER 6: input =&gt;",input)</div>
<div class="viewcode-block" id="ObliviousTransfer.receiver_transfer6"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer.receiver_transfer6">[docs]</a>        if input == 'GO':
            (pk, V, v, query) = Protocol.get(self, ['S','V','v','query'])
            pk['V'], pk['v'], pk['sigma'] = V, v, query
            # set up client end of PoK2
            PoK2 = SigmaProtocol2(self.group, pk)
            PoK2.setup( {'name':'prover', 'type':PoK2.PROVER, 'socket':self._socket} )
            PoK2.execute(PoK2.PROVER, close_sock=False)
            print("PoK2 prover result =&gt;", PoK2.result)
            result = PoK2.result            
            Protocol.setState(self, 8)
            return {'Pok2':result}
        
        Protocol.setState(self, None)            
        return None

    def receiver_transfer8(self, input):
        print("RECEIVER 8:")</div>
<div class="viewcode-block" id="ObliviousTransfer.receiver_transfer8"><a class="viewcode-back" href="../schemes/protocol_cns07.html#protocol_cns07.ObliviousTransfer.receiver_transfer8">[docs]</a>        if input['PoK2'] != 'OK':
            Protocol.setState(self, None)
            return None
        
        if input.get('PoM') != None:    
#            print("Executing the PoM interactive proof.")
            pk = Protocol.get(self, ['W'], dict)
            PoM = SigmaProtocol3(self.group, pk)
            PoM.setup( {'name':'verifier', 'type':PoM.VERIFIER, 'socket': self._socket} )
            Protocol.send_msg(self, 'GO') # important: 1. acknowledges sub-protocol transition, 2. sends a short message using this socket
            PoM.execute(PoM.VERIFIER, close_sock=False)
            result = PoM.result
            print("PoM verifier result =&gt;", result)
        
        if result == 'OK':
#            print("Now we recover ")
            # W allows us to unlock the appropriate keyword, right?
            # get query, B_query, and v
            (W, v, C) = Protocol.get(self, ['W','v','C'])
            index = 0
            B = C[index]['B']
            w = W ** ~v
            # m = self.xor(B, w)
            print("Query =&gt;", index)
            print("Corresponding B =&gt;", B)
            print("Original message key =&gt;", w)
            print("Search complete!!!")
        Protocol.setState(self, None)
        return None    

if __name__ == "__main__":
    if len(sys.argv) != 2:</div></div>
        print("Usage: %s [-r or -s]" % sys.argv[0])
        exit(-1)

    if sys.argv[1] == "-r":
        print("Operating as receiver...")
        svr = socket(AF_INET, SOCK_STREAM)
        svr.bind((HOST, PORT))
        svr.listen(1)
        svr_sock, addr = svr.accept()
        print("Connected by ", addr)
        msgs = None
        _name, _type, _sock = "receiver", RECEIVER, svr_sock
#       sp.setup( {'name':"receiver", 'type':_type, 'socket':svr_sock} )
    elif sys.argv[1] == "-s":
        print("Operating as sender...")
        clt = socket(AF_INET, SOCK_STREAM)
        clt.connect((HOST, PORT))
        clt.settimeout(15)
        msgs = ['one', 'two', 'three']
        _name, _type, _sock = "sender", SENDER, clt
    else:
        print("Usage: %s -r or -s" % sys.argv[0])
        exit(-1)
    
#    group = PairingGroup('library/a.param')
    sp = ObliviousTransfer(msgs)
    sp.setup( {'name':_name, 'type':_type, 'socket':_sock} )
    # run as a thread...
    sp.execute(_type)
</pre>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Charm-Crypto 0.4b documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Johns Hopkins University ISI.
      Last updated on Feb 19, 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1pre.
    </div>
  </body>
</html>